<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Faculty Whereabouts</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', 'Inter', Arial, sans-serif;
      background: linear-gradient(135deg, #eef2f7, #dbe5f5);
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    header {
      background: radial-gradient(circle at 60% 40%, #2563eb 0%, #1e3a8a 100%);
      color: #fff;
      padding: 0.7em 2vw;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      height: 7.5vh;
      border-radius: 5px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(16, 34, 74, .10);
      border: 2px solid #2563eb;
    }

    .header-center {
      text-align: center;
      flex: 1;
      color: #fff;
      font-family: 'Orbitron', 'Inter', Arial, sans-serif;
    }

    .header-center h1 {
      margin: 0;
      font-size: 3.5vh;
      font-weight: 700;
      text-shadow: 1px 1px 2px #00000077;
    }

    .header-center h2 {
      margin: 0;
      font-size: 3vh;
      font-weight: 500;
      text-shadow: 1px 1px 2px #00000055;
    }

    #clock {
      position: fixed;
      right: 2vw;
      bottom: 10vh;
      z-index: 1000;
      background: #111827;
      border-radius: 10px;
      padding: 0.5em 0.4em;
      width: 280px;
      height: 80px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #38bdf8;
      box-shadow: 0 0 16px #38bdf888, 0 0 4px #2563eb;
      white-space: nowrap;
      gap: 0.1em;
    }

    /* ADD / REPLACE THESE NEW LAYOUT STYLES (keep previous global styles you need) */

    /* Remove old overlay styles block (#adOverlay...) */
    #adOverlay, #adOverlay * { display:none !important; }

    .main-row {
      display: flex;
      width: 100%;
      height: calc(100vh -  (var(--header-h,0px)) - (var(--footer-h,0px)));
      /* heights assigned after layout calc */
    }

    .faculty-area {
      flex: 2 1 66.666%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 0 1vw 0 2vw;
      box-sizing: border-box;
    }

    .grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-auto-rows: 1fr;
      gap: 0.9vh;
      padding: 0.8vh 0 0.8vh 0;
      height: 100%;
      box-sizing: border-box;
      overflow: hidden;
    }

    .ad-panel {
      flex: 1 1 33.333%;
      display: flex;
      flex-direction: column;
      padding: 0.8vh 2vw 0.8vh 1vw;
      box-sizing: border-box;
    }

    .ad-stage {
      position: relative;
      flex: 1;
      background: #0f172a;
      border: 3px solid #2563eb;
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      box-shadow: 0 6px 20px -4px rgba(16,34,74,.35);
    }

    .ad-stage img,
    .ad-stage video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
      display: none;
    }

    .ad-badge {
      position: absolute;
      top: 6px;
      right: 10px;
      background: #2563eb;
      color: #fff;
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 999px;
      letter-spacing: .06em;
      box-shadow: 0 0 8px #2563eb99;
      z-index: 2;
      font-family: 'Orbitron', 'Inter', sans-serif;
    }

    .ad-progress {
      position: absolute;
      left: 10px;
      right: 10px;
      bottom: 10px;
      height: 6px;
      background: #1e3a8a;
      border-radius: 4px;
      overflow: hidden;
      z-index: 2;
    }

    .ad-progress-bar {
      width: 0;
      height: 100%;
      background: linear-gradient(90deg,#38bdf8,#2563eb);
      transition: width .25s linear;
    }

    /* Adjust clock (optional: keep as-is if you prefer fixed) */
    #clock { top: auto; }

    /* Small width fallback (stack) */
    @media (max-width: 900px) {
      .main-row { flex-direction: column; }
      .faculty-area, .ad-panel { flex: unset; width: 100%; height: 50%; padding: 0.6vh 2vw; }
      .ad-panel { order: 2; }
      .grid { grid-template-columns: repeat(auto-fit,minmax(150px,1fr)); }
    }
  </style>
</head>
<body>
  <header>
    <!-- existing header -->
    <img src="images/ugv_logo.png" alt="UGV Logo" class="logo">
    <div class="header-center">
      <h1>Department of Computer Science & Engineering</h1>
      <h2>University of Global Village</h2>
    </div>
    <div id="clock"></div>
    <img src="images/cse_logo.png" alt="CSE Logo" class="logo">
  </header>

  <!-- REPLACE previous <div id="grid"> and overlay with this structure -->
  <div id="mainRow" class="main-row">
    <div class="faculty-area">
      <div id="grid" class="grid"></div>
    </div>
    <aside id="adPanel" class="ad-panel">
      <div class="ad-stage" id="adStage">
        <span class="ad-badge">AD</span>
        <img id="adImage" alt="Ad">
        <video id="adVideo" autoplay muted playsinline webkit-playsinline preload="auto" crossorigin="anonymous"></video>
        <div class="ad-progress"><div id="adProgressBar" class="ad-progress-bar"></div></div>
      </div>
    </aside>
  </div>

  <!-- REMOVE the old #adOverlay block entirely -->

  <footer id="marqueeFooter">
    <div id="dateDisplay"></div>
    <div id="marqueeText"></div>
  </footer>

  <script>
    const STATUS_MAP = {
      in_class: "In Class",
      at_dept: "At Department",
      on_leave: "On Leave",
      off_duty: "Off Duty",
      in_meeting: "In Meeting",
      on_weekend: "On Weekend",
      postponed: "Class Postponed"
    };

    const SEGMENTS = {
      "0": ["a", "b", "c", "d", "e", "f"],
      "1": ["b", "c"],
      "2": ["a", "b", "g", "e", "d"],
      "3": ["a", "b", "g", "c", "d"],
      "4": ["f", "g", "b", "c"],
      "5": ["a", "f", "g", "c", "d"],
      "6": ["a", "f", "g", "e", "c", "d"],
      "7": ["a", "b", "c"],
      "8": ["a", "b", "c", "d", "e", "f", "g"],
      "9": ["a", "b", "c", "d", "f", "g"]
    };

    // Add these missing declarations:
    let ads = [];
    let nextAdTimeout = null;
    let marqueeAnimation = null; // Track the animation
    let clockContainer = null;
    let dateDisplay = null;

    function loadFaculty() {
      try {
        fetch("https://faculty-status-backend.onrender.com/api/faculty", {
          credentials: "include"
        })
          .then(res => res.json())
          .then(data => {
            const grid = document.getElementById("grid");
            const fragment = document.createDocumentFragment();
            
            data.forEach(f => {
              let statusObj = f.manualOverride ?? f.status;
              let statusStr, room, batch;

              if (typeof statusObj === "string") {
                statusStr = statusObj;
                room = null;
                batch = null;
              } else if (typeof statusObj === "object" && statusObj !== null) {
                statusStr = statusObj.status;
                room = statusObj.room ?? null;
                batch = statusObj.batch ?? null;
              }

              let extraInfo = "";
              if (statusStr === "in_class" && room && batch) {
                extraInfo = `<small class="text-gray">with ${batch} at ${room}</small>`;
              }

              const cardDiv = document.createElement('div');
              cardDiv.className = 'card';
              cardDiv.innerHTML = `
                <img src="https://faculty-status-backend.onrender.com${f.image}" alt="${f.name}">
                <h3>${f.name}</h3>
                <div>${f.designation || ""}</div>
                <div>${f.contact ? `<svg class="icon-phone" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg> ${f.contact}` : ""}</div>
                <div>${f.email ? `<svg class="icon-email" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg> ${f.email}` : ""}</div>
                <div class="status ${statusStr}">
                  ${STATUS_MAP[statusStr] || statusStr} ${extraInfo}
                </div>
              `;
              fragment.appendChild(cardDiv);
            });
            
            grid.innerHTML = '';
            grid.appendChild(fragment);
          })
          .catch(err => {
            console.error("Failed to load faculty:", err);
            // Retry after 10 seconds
            setTimeout(loadFaculty, 10000);
          });
      } catch (error) {
        console.error("Faculty loading error:", error);
      }
    }

    function renderDigit(digit) {
      const segs = SEGMENTS[digit] || [];
      return `
    <span class="digit-bg">
      <svg width="32" height="56" viewBox="0 0 32 56" class="seven-segment">
        <rect class="seg seg-a${segs.includes('a') ? ' lit' : ''}" x="4" y="2" width="24" height="4" rx="2"/>
        <rect class="seg seg-b${segs.includes('b') ? ' lit' : ''}" x="26" y="6" width="4" height="20" rx="2"/>
        <rect class="seg seg-c${segs.includes('c') ? ' lit' : ''}" x="26" y="30" width="4" height="20" rx="2"/>
        <rect class="seg seg-d${segs.includes('d') ? ' lit' : ''}" x="4" y="50" width="24" height="4" rx="2"/>
        <rect class="seg seg-e${segs.includes('e') ? ' lit' : ''}" x="2" y="30" width="4" height="20" rx="2"/>
        <rect class="seg seg-f${segs.includes('f') ? ' lit' : ''}" x="2" y="6" width="4" height="20" rx="2"/>
        <rect class="seg seg-g${segs.includes('g') ? ' lit' : ''}" x="4" y="26" width="24" height="4" rx="2"/>
      </svg>
    </span>
  `;
    }

    function renderColon() {
      return `
    <span class="digit-bg colon">
      <svg width="12" height="56" viewBox="0 0 12 56">
        <circle cx="6" cy="16" r="3" fill="#38bdf8" filter="url(#glow)"/>
        <circle cx="6" cy="40" r="3" fill="#38bdf8" filter="url(#glow)"/>
        <defs>
          <filter id="glow" x="-5" y="-5" width="22" height="22">
            <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
            <feMerge>
              <feMergeNode in="coloredBlur"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>
      </svg>
    </span>
  `;
    }

    function renderClock(h, m, s, ampm) {
      if (!clockContainer) {
        clockContainer = document.getElementById("clock");
      }
      
      const digits = [
        ...String(h).padStart(2, '0'),
        ...String(m).padStart(2, '0'),
        ...String(s).padStart(2, '0')
      ];
      
      const html = `
        ${renderDigit(digits[0])}
        ${renderDigit(digits[1])}
        ${renderColon()}
        ${renderDigit(digits[2])}
        ${renderDigit(digits[3])}
        ${renderColon()}
        ${renderDigit(digits[4])}
        ${renderDigit(digits[5])}
        <span class="ampm">${ampm}</span>
      `;
      
      clockContainer.innerHTML = html;
    }

    function updateClock() {
      const now = new Date();
      let h = now.getHours();
      let m = now.getMinutes();
      let s = now.getSeconds();
      const ampm = h >= 12 ? 'PM' : 'AM';
      h = h % 12;
      h = h ? h : 12;
      renderClock(h, m, s, ampm);
    }

    document.addEventListener("DOMContentLoaded", function () {
      // Initial setup
      updateClock();
      updateDate();
      loadFaculty();
      loadMarquee();
      loadAds(); // Load ads initially
      adjustLayout();

      // Start marquee animation ONCE
      setTimeout(() => {
        animateMarquee();
      }, 1000);

      // Set up intervals (only once)
      setInterval(updateClock, 1000);
      setInterval(loadFaculty, 3000);
      setInterval(loadMarquee, 300000);
      setInterval(loadAds, 300000); // Refresh ads every 5 minutes
      setInterval(updateDate, 60000);
    });

    window.addEventListener("resize", adjustLayout);

    // Update adjustLayout to set CSS vars & heights for new layout
    function adjustLayout() {
      const header = document.querySelector("header");
      const footer = document.getElementById("marqueeFooter");
      const hH = header.offsetHeight;
      const fH = footer.offsetHeight;
      document.documentElement.style.setProperty('--header-h', hH + 'px');
      document.documentElement.style.setProperty('--footer-h', fH + 'px');
      const mainRow = document.getElementById("mainRow");
      mainRow.style.height = `calc(100vh - ${hH}px - ${fH}px)`;
    }

    // Faculty load unchanged except you can keep all cards now (no overlay conflict)
    // ...existing loadFaculty()...

    // Replace setAdStretch (panel auto fits via object-fit)
    function setAdStretch() { /* no-op (kept for compatibility) */ }

    // Inline ad progress
    function updateAdProgress(duration, elapsed=0){
      const bar = document.getElementById("adProgressBar");
      bar.style.width = ((elapsed / duration) * 100) + "%";
    }

    // Update runAdSequence to use side panel only
    function runAdSequence() {
      if (!ads.length) return;
      let totalAdTime = 0;
      let current = 0;

      const adImage = document.getElementById("adImage");
      const adVideo = document.getElementById("adVideo");

      function showNext() {
        if (current >= ads.length) {
          // Break logic
            let breakMs = 60000;
            if (totalAdTime > 120000) breakMs = 240000;
            else if (totalAdTime > 30000) breakMs = 120000;
            console.log("Ad cycle done. Break(ms):", breakMs);
            nextAdTimeout = setTimeout(runAdSequence, breakMs);
            return;
        }

        const ad = ads[current];
        adImage.style.display = "none";
        adVideo.style.display = "none";

        if (ad.type === "image") {
          const duration = 20000;
          updateAdProgress(duration,0);
          adImage.src = "https://faculty-status-backend.onrender.com" + ad.src;
          adImage.onload = ()=>{ adImage.style.display='block'; };
          let elapsed = 0;
          const interval = setInterval(()=>{
            elapsed += 250;
            updateAdProgress(duration, elapsed);
            if (elapsed >= duration) {
              clearInterval(interval);
              totalAdTime += duration;
              current++;
              showNext();
            }
          },250);
        } else if (ad.type === "video") {
          const DEFAULT_DURATION = 30000;
          let duration = DEFAULT_DURATION;
          let started = false;
          adVideo.pause();
          adVideo.removeAttribute("src");
          adVideo.load();

          function begin() {
            if (started) return;
            started = true;
            adVideo.style.display = 'block';
            if (isFinite(adVideo.duration) && adVideo.duration > 0) {
              duration = adVideo.duration * 1000;
            }
            adVideo.play().catch(()=>{ totalAdTime += duration; current++; showNext(); });
            updateAdProgress(duration,0);
            const startTs = Date.now();
            const pi = setInterval(()=>{

              const el = Date.now() - startTs;

              if (adVideo.ended) {
                console.log("Video ended naturally");
                updateAdProgress(duration, duration);
                clearAll(true);
                return;
              }

              if (el >= duration) {
                console.log("Reached duration limit, ending video");
                updateAdProgress(duration, duration);
                clearAll(true);
                return;
              }

              updateAdProgress(duration, el);
            }, 250);

            adVideo.onended = () => {
              console.log("Video ended event fired");
              updateAdProgress(duration, duration);
              clearAll(true);
            };
          }

          adVideo.oncanplay = begin;
          adVideo.onloadeddata = begin;
          setTimeout(begin, 2500);
          adVideo.onerror = ()=>{ totalAdTime += duration; current++; showNext(); };
          adVideo.onstalled = ()=>{ totalAdTime += duration; current++; showNext(); };
          adVideo.src = "https://faculty-status-backend.onrender.com" + ad.src;
          adVideo.load();
        }
      }
      showNext();
    }

    // loadAds unchanged except remove overlay condition
    function loadAds() {
      fetch("https://faculty-status-backend.onrender.com/api/ads")
        .then(r=>r.json())
        .then(data=>{
          ads = data;
          if (ads.length && !nextAdTimeout) runAdSequence();
        })
        .catch(e=>{
          console.error("Ads load failed",e);
          setTimeout(loadAds,30000);
        });
    }

    // DOMContentLoaded: keep, but REMOVE overlay references
    document.addEventListener("DOMContentLoaded", function(){
      updateClock();
      updateDate();
      loadFaculty();
      loadMarquee();
      loadAds();
      adjustLayout();
      setTimeout(()=>animateMarquee(),1000);

      setInterval(updateClock,1000);
      setInterval(loadFaculty,3000);
      setInterval(loadMarquee,300000);
      setInterval(loadAds,300000);
      setInterval(updateDate,60000);
    });

    window.addEventListener("resize", adjustLayout);
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Faculty Whereabouts</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', 'Inter', Arial, sans-serif;
      background: linear-gradient(135deg, #eef2f7, #dbe5f5);
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    header {
      background: radial-gradient(circle at 60% 40%, #2563eb 0%, #1e3a8a 100%);
      color: #fff;
      padding: 0.5em 2vw;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      height: 6vh;
      border-radius: 5px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(16, 34, 74, .10);
      border: 2px solid #2563eb;
    }

    .header-center {
      text-align: center;
      flex: 1;
      color: #fff;
      font-family: 'Orbitron', 'Inter', Arial, sans-serif;
    }

    .header-center h1 {
      margin: 0;
      font-size: 2.8vh;
      font-weight: 700;
      text-shadow: 1px 1px 2px #00000077;
    }

    .header-center h2 {
      margin: 0;
      font-size: 2.4vh;
      font-weight: 500;
      text-shadow: 1px 1px 2px #00000055;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-auto-rows: 1fr;
      gap: 0.7vh;
      padding: 1vh 2vw;
      box-sizing: border-box;
      overflow: visible;
      contain: layout style;
      will-change: contents;
    }

    .card {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 8px 28px -6px rgba(16, 34, 74, .14), 0 4px 12px -4px rgba(16, 34, 74, .12);
      color: #1e3a8a;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 0.2vh;
      font-size: 1.5vh;
      overflow: hidden;
      box-sizing: border-box;
      padding: 0.5vh 0.5vw;
      contain: layout style;
    }

    .card img {
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(16, 34, 74, .10);
      border: 2px solid #2563eb;
      width: 4.5vh;
      height: 4.5vh;
      object-fit: cover;
      margin-bottom: 0.2vh;
    }

    .card h3 {
      color: #2563eb;
      font-weight: 600;
      margin: 0;
      text-align: center;
      width: 100%;
      overflow-wrap: break-word;
      word-wrap: break-word;
      hyphens: auto;
      font-size: 1.05em;
      line-height: 1.2;
    }

    .card div,
    .card i,
    .status {
      color: #374151;
      font-weight: 500;
      text-align: center;
      width: 100%;
      margin: 0;
    }

    .card .designation {
      font-size: 0.85em;
      line-height: 1.1;
      max-width: 100%;
      overflow-wrap: break-word;
      word-wrap: break-word;
      hyphens: auto;
      margin: 0;
      padding: 0.1em 0;
    }

    .card .contact-info {
      font-size: 0.75em;
      line-height: 1.15;
      width: 100%;
      text-align: center;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 0.3em;
      padding: 0.05em 0.2em;
      box-sizing: border-box;
      flex-wrap: wrap;
    }

    .card .contact-info span {
      flex: 0 1 auto;
      min-width: 0;
      word-break: break-word;
      overflow-wrap: break-word;
      max-width: 85%;
    }

    .status {
      border-radius: 8px;
      padding: 0.25em 0.6em;
      font-size: 0.9em;
      box-shadow: 0 2px 8px rgba(16, 34, 74, .08);
      display: inline-block;
      margin-top: 0.15em;
      line-height: 1.2;
    }

    .status.in_class {
      background: #e0e7ff;
      color: #2563eb;
      border-radius: 8px;
      font-weight: 600;
    }

    .status.at_dept {
      background: #d1fae5;
      color: #059669;
      border-radius: 8px;
      font-weight: 600;
    }

    .status.in_meeting,
    .status.exam_duty {
      background: #fef3c7;
      color: #b45309;
      border-radius: 8px;
      font-weight: 600;
    }

    .status.on_leave {
      background: #fee2e2;
      color: #dc2626;
      border-radius: 8px;
      font-weight: 600;
    }

    .status.off_duty,
    .status.on_break {
      background: #e5e7eb;
      color: #374151;
      border-radius: 8px;
      font-weight: 600;
    }

    .status.on_weekend {
      background: #ffe4e6;
      color: #be123c;
      border-radius: 8px;
      font-weight: 600;
    }

    .status.postponed {
      background: #fecaca;
      color: #991b1b;
      border-radius: 8px;
      font-weight: 600;
    }

    ::-webkit-scrollbar {
      width: 8px;
      background: #dbe5f5;
    }

    ::-webkit-scrollbar-thumb {
      background: #2563eb;
      border-radius: 8px;
    }

    .icon-phone,
    .icon-email {
      font-size: 0.95em;
      color: #2563eb;
      flex-shrink: 0;
      display: inline-block;
      width: auto;
      text-align: center;
      line-height: 1;
    }

    @media (max-width: 700px) {
      .grid {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        grid-auto-rows: auto;
      }
    }

    /* --- Ad Overlay Styles --- */
    #adOverlay {
      position: fixed;
      left: 0;
      width: 100vw;
      background: rgba(0, 0, 0, 0.85);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      display: flex;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.7s;
      contain: layout style paint;
    }

    #adOverlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    #adOverlay img,
    #adOverlay video {
      display: none;
      background: #000;
      width: 100%;
      height: 100%;
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      opacity: 1;
    }

    #adOverlay.stretch-horizontal img,
    #adOverlay.stretch-horizontal video {
      width: 100%;
      height: auto;
      max-height: 100%;
      object-fit: contain;
    }

    #adOverlay.stretch-vertical img,
    #adOverlay.stretch-vertical video {
      height: 100%;
      width: auto;
      max-width: 100%;
      object-fit: contain;
    }

    /* --- Marquee Footer Styles --- */
    #marqueeFooter {
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100vw;
      height: 1.5em;
      background: #1e293b;
      color: #fff;
      font-size: 1em;
      z-index: 10000;
      overflow: hidden;
      font-family: 'Orbitron', 'Inter', Arial, sans-serif;
      border-top: 2px solid #374151;
      padding-top: 2px;
      display: flex;
      align-items: center;
    }

    #dateTimeDisplay {
      position: absolute;
      left: 0;
      top: 2px;
      bottom: 0;
      background: #2563eb;
      color: #fff;
      padding: 0.1em 0.3em;
      font-weight: 600;
      white-space: nowrap;
      border-right: 2px solid #38bdf8;
      min-width: 140px;
      max-width: 160px;
      text-align: center;
      box-shadow: 0 0 8px #2563eb44;
      font-size: 0.65em;
      line-height: 0.9;
      display: flex;
      flex-direction: column;
      justify-content: center;
      z-index: 10002;
    }

    .clock-section {
      font-size: 1em;
      margin-bottom: 1px;
      color: #fff;
    }

    .date-section {
      font-size: 0.8em;
      color: #fff;
    }

    .time-separator {
      width: 70%;
      height: 1px;
      background: #38bdf8;
      margin: 1px auto;
      opacity: 0.6;
    }

    #marqueeText {
      position: absolute;
      left: 160px;
      top: 2px;
      bottom: 0;
      right: 0;
      white-space: nowrap;
      will-change: transform;
      overflow: visible;
      transform: translateZ(0);
      backface-visibility: hidden;
      display: flex;
      align-items: center;
      padding-left: 1em;
      transform-style: preserve-3d;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      z-index: 10001;
    }

    #adProgress {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 2px;
      background: #0f172a;
      z-index: 10004;
      border-top: 1px solid #475569;
    }

    #adProgressBar {
      height: 100%;
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      width: 0;
      transition: width 0.1s ease-out;
      will-change: width;
      box-shadow: 0 0 4px rgba(59, 130, 246, 0.5);
      position: relative;
    }

    #adCountdownText {
      position: absolute;
      top: 60%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      font-size: 7px;
      font-weight: 600;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.9);
      font-family: 'Orbitron', 'Inter', Arial, sans-serif;
      pointer-events: none;
      z-index: 10005;
      opacity: 0;
      transition: opacity 0.3s ease;
      white-space: nowrap;
      height: auto;
    }

    #adCountdownText.show {
      opacity: 1;
    }

    /* Enhanced colors for break vs waiting */
    #adProgress.break-countdown #adProgressBar {
      background: linear-gradient(90deg, #059669, #10b981);
      box-shadow: 0 0 4px rgba(16, 185, 129, 0.5);
    }

    #adProgress.waiting-countdown #adProgressBar {
      background: linear-gradient(90deg, #dc2626, #ef4444);
      box-shadow: 0 0 4px rgba(239, 68, 68, 0.5);
    }
  </style>
</head>

<body>
  <header>
    <img src="images/ugv_logo.png" alt="UGV Logo" class="logo">
    <div class="header-center">
      <h1>Department of Computer Science & Engineering</h1>
      <h2>University of Global Village</h2>
    </div>
    <!-- <img src="images/cse_logo.png" alt="CSE Logo" class="logo"> -->
  </header>

  <div id="grid" class="grid"></div>

  <!-- Ad Overlay -->
  <div id="adOverlay">
    <img id="adImage" src="" />
    <video id="adVideo" autoplay muted playsinline webkit-playsinline preload="auto" crossorigin="anonymous"></video>
  </div>

  <!-- Marquee Footer -->
  <footer id="marqueeFooter">
    <div id="dateTimeDisplay">
      <div class="clock-section" id="clock"></div>
      <div class="time-separator"></div>
      <div class="date-section" id="dateDisplay"></div>
    </div>
    <div id="marqueeText"></div>
    <div id="adProgress">
      <div id="adProgressBar"></div>
      <div id="adCountdownText">Notice in: 00:00</div>
    </div>
  </footer>

  <script>
    const STATUS_MAP = {
      in_class: "In Class",
      at_dept: "At Department",
      on_leave: "On Leave",
      off_duty: "Off Duty",
      in_meeting: "In Meeting",
      on_weekend: "On Weekend",
      postponed: "Class Postponed",
      exam_duty: "On Exam Invigilation",
      on_break: "On Break"
    };

    // Global variables with proper state management
    let ads = [];
    let nextAdTimeout = null;
    let adCycleRunning = false;
    let inBreakPeriod = false;
    let breakEndsAt = 0;
    let breakStartTime = 0;
    let marqueeAnimation = null;
    let clockContainer = null;
    let dateDisplay = null;
    let currentMarqueeText = '';
    let marqueeCheckInterval = null;

    // Global variables for smooth animation
    let countdownAnimationId = null;

    // Ad configuration constants
    const IMAGE_AD_DURATION = 15000; // 15 seconds for images
    const MAX_VIDEO_CAP_MS = 5 * 60 * 1000; // 5 minute safety cap for videos
    const VIDEO_DURATION_READY_DELAY = 1200; // ms after play() to re-check metadata

    function loadFaculty() {
      try {
        fetch("https://faculty-status-display.onrender.com/api/faculty", {
          credentials: "include"
        })
          .then(res => res.json())
          .then(data => {
            // Sort faculty by precedence (lower numbers first), then by name
            const sortedData = data.sort((a, b) => {
              const precedenceA = a.precedence || 50;
              const precedenceB = b.precedence || 50;
              
              if (precedenceA !== precedenceB) {
                return precedenceA - precedenceB;
              }
              return a.name.localeCompare(b.name);
            });

            const grid = document.getElementById("grid");
            const fragment = document.createDocumentFragment();

            // Dynamic column calculation based on faculty count
            const facultyCount = sortedData.length;
            let columns = 5; // Default for â‰¤15 faculty
            if (facultyCount > 15 && facultyCount <= 24) {
              columns = 6;
            } else if (facultyCount > 24) {
              columns = 6; // Max 6 columns for >24
              console.warn(`âš ï¸ ${facultyCount} faculty members may exceed optimal display capacity (24)`);
            }
            grid.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;

            sortedData.forEach(f => {
              // Debug: Log first faculty member to check data structure
              if (sortedData.indexOf(f) === 0) {
                console.log("Sample faculty data:", f);
              }

              let statusObj = f.manualOverride ?? f.status;
              let statusStr, room, batch;

              if (typeof statusObj === "string") {
                statusStr = statusObj;
                room = null;
                batch = null;
              } else if (typeof statusObj === "object" && statusObj !== null) {
                statusStr = statusObj.status;
                room = statusObj.room ?? null;
                batch = statusObj.batch ?? null;
              }

              let extraInfo = "";
              if (statusStr === "in_class" && room && batch) {
                extraInfo = `<small class="text-gray">with ${batch} at ${room}</small>`;
              }

              const cardDiv = document.createElement('div');
              cardDiv.className = 'card';
              cardDiv.innerHTML = `
                <img src="https://faculty-status-display.onrender.com${f.image}" alt="${f.name}">
                <h3>${f.name}</h3>
                <div class="designation">${f.designation || ""}</div>
                <div class="contact-info">${f.contact ? `<i class="fas fa-phone icon-phone"></i><span>${f.contact}</span>` : ""}</div>
                <div class="contact-info">${f.email ? `<i class="fas fa-envelope icon-email"></i><span>${f.email}</span>` : ""}</div>
                <div class="status ${statusStr}">
                  ${STATUS_MAP[statusStr] || statusStr} ${extraInfo}
                </div>
              `;
              fragment.appendChild(cardDiv);
            });

            grid.innerHTML = '';
            grid.appendChild(fragment);
          })
          .catch(err => {
            console.error("Failed to load faculty:", err);
            setTimeout(loadFaculty, 10000);
          });
      } catch (error) {
        console.error("Faculty loading error:", error);
      }
    }

    function updateClock() {
      if (!clockContainer) {
        clockContainer = document.getElementById("clock");
      }

      const now = new Date();
      let h = now.getHours();
      let m = now.getMinutes();
      let s = now.getSeconds();
      const ampm = h >= 12 ? 'PM' : 'AM';
      h = h % 12;
      h = h ? h : 12;

      const timeString = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')} ${ampm}`;
      
      clockContainer.textContent = timeString;
    }

    function adjustLayout() {
      const header = document.querySelector("header");
      const footer = document.getElementById("marqueeFooter");
      const grid = document.getElementById("grid");
      const overlay = document.getElementById("adOverlay");
      const headerHeight = header.offsetHeight;
      const footerHeight = footer.offsetHeight;
      grid.style.height = `calc(100vh - ${headerHeight}px - ${footerHeight}px)`;
      overlay.style.top = headerHeight + "px";
      overlay.style.height = `calc(100vh - ${headerHeight}px - ${footerHeight}px)`;
    }

    function showOverlay() {
      const overlay = document.getElementById("adOverlay");
      overlay.classList.add("active");
    }

    function hideOverlay() {
      const overlay = document.getElementById("adOverlay");
      overlay.classList.remove("active", "stretch-horizontal", "stretch-vertical");
    }

    function setAdStretch(mediaEl) {
      const overlay = document.getElementById("adOverlay");
      overlay.classList.remove("stretch-horizontal", "stretch-vertical");
      const overlayRect = overlay.getBoundingClientRect();
      let mediaWidth, mediaHeight;

      if (mediaEl.tagName === "IMG") {
        mediaWidth = mediaEl.naturalWidth;
        mediaHeight = mediaEl.naturalHeight;
      } else if (mediaEl.tagName === "VIDEO") {
        mediaWidth = mediaEl.videoWidth;
        mediaHeight = mediaEl.videoHeight;
      }

      if (mediaWidth && mediaHeight) {
        if ((mediaWidth / mediaHeight) > (overlayRect.width / overlayRect.height)) {
          overlay.classList.add("stretch-horizontal");
        } else {
          overlay.classList.add("stretch-vertical");
        }
      }
    }

    function updateAdProgress(total, elapsed = 0) {
      const bar = document.getElementById("adProgressBar");
      const countdownText = document.getElementById("adCountdownText");

      if (adCycleRunning) {
        // During ads: normal progress, hide countdown
        const percentage = Math.min(100, (elapsed / total) * 100);
        bar.style.width = percentage + "%";
        countdownText.classList.remove("show");
        document.getElementById("adProgress").className = "";
        document.getElementById("adProgress").style.display = "block";
      }
    }

    function loadAds() {
      fetch("https://faculty-status-display.onrender.com/api/ads")
        .then(r => r.json())
        .then(data => {
          ads = data;
          console.log("Ads loaded:", ads.length);

          // Only try to start if we're not in break period and not already running
          if (!inBreakPeriod && !adCycleRunning && ads.length > 0) {
            checkAndStartAds();
          }
        })
        .catch(e => {
          console.error("Failed to load ads:", e);
          setTimeout(loadAds, 30000);
        });
    }

    function checkAndStartAds() {
      const now = Date.now();

      // If we're in a break period
      if (inBreakPeriod) {
        if (now >= breakEndsAt) {
          // Break is over, reset state
          inBreakPeriod = false;
          console.log("âœ… Break period ended. Ads can now start.");

          // Clear any pending timeout
          if (nextAdTimeout) {
            clearTimeout(nextAdTimeout);
            nextAdTimeout = null;
          }

          // Start ads immediately after break
          if (ads.length > 0 && !adCycleRunning) {
            runAdSequence();
          }
        } else {
          const remainingBreak = Math.ceil((breakEndsAt - now) / 1000);
          console.log("â¸ï¸ Still in break period. Remaining:", remainingBreak, "seconds");
        }
        return;
      }

      // Not in break and not running, start ads
      if (!adCycleRunning && ads.length > 0) {
        runAdSequence();
      }
    }

    // Update your existing startBreakPeriod function:
    function startBreakPeriod(totalAdDuration) {
      // Calculate break duration based on cumulative ad duration
      let breakDurationMs = 60000; // Default 1 minute

      if (totalAdDuration > 120000) {       // > 2 minutes of ads
        breakDurationMs = 240000;           // 4 minutes break
      } else if (totalAdDuration > 30000 && totalAdDuration <= 60000) { // 30 seconds to 1 minute of ads
        breakDurationMs = 120000;           // 2 minutes break
      } else if (totalAdDuration > 60000) { // > 1 minute of ads
        breakDurationMs = 180000;            // 3 minutes break
      }

      // Set break period flags
      inBreakPeriod = true;
      breakStartTime = Date.now();
      breakEndsAt = breakStartTime + breakDurationMs;

      console.log("ðŸ›‘ STARTING BREAK PERIOD");
      console.log("ðŸ“Š Total ad duration was:", Math.round(totalAdDuration / 1000), "seconds");
      console.log("â° Break duration:", Math.round(breakDurationMs / 1000), "seconds");
      console.log("ðŸ”„ Next ads will start at:", new Date(breakEndsAt).toLocaleTimeString());

      // Start smooth countdown animation
      startSmoothCountdown();

      // Schedule end of break
      nextAdTimeout = setTimeout(() => {
        inBreakPeriod = false;
        breakStartTime = 0;
        nextAdTimeout = null;
        stopSmoothCountdown(); // Stop smooth animation
        console.log("âœ… Break period completed! Ready for next ad cycle.");

        // Try to start ads immediately after break ends
        if (ads.length > 0 && !adCycleRunning) {
          runAdSequence();
        }
      }, breakDurationMs);
    }

    function runAdSequence() {
      if (inBreakPeriod || adCycleRunning || !ads.length) {
        console.log("âš ï¸ Cannot start ads:", {
          inBreak: inBreakPeriod,
          running: adCycleRunning,
          hasAds: ads.length > 0
        });
        return;
      }

      adCycleRunning = true;
      stopSmoothCountdown(); // Stop countdown animation during ads
      showOverlay();
      console.log("ðŸŽ¬ STARTING AD SEQUENCE - " + ads.length + " ads");

      const adImage = document.getElementById("adImage");
      const adVideo = document.getElementById("adVideo");
      let current = 0;
      let totalAdTime = 0; // This accumulates the actual ad durations

      function finishAdSequence() {
        hideOverlay();
        adCycleRunning = false;

        console.log("ðŸ AD SEQUENCE COMPLETE");
        console.log("ðŸ“º Total ads shown:", ads.length);
        console.log("â±ï¸ Total ad time:", Math.round(totalAdTime / 1000), "seconds");

        // Start break period (no ads during break)
        startBreakPeriod(totalAdTime);
      }

      function nextAd() {
        current++;
        playNextAd();
      }

      function playNextAd() {
        if (current >= ads.length) {
          finishAdSequence();
          return;
        }

        const ad = ads[current];
        adImage.style.display = "none";
        adVideo.style.display = "none";

        if (ad.type === "image") {
          // Images: fixed 20-second duration
          const duration = IMAGE_AD_DURATION;
          console.log(`ðŸ“· Image ${current + 1}/${ads.length}: ${ad.src} (${duration / 1000}s)`);

          updateAdProgress(duration, 0);
          adImage.src = "https://faculty-status-display.onrender.com" + ad.src;
          adImage.onload = () => {
            adImage.style.display = "block";
            setAdStretch(adImage);
          };

          let startTime = Date.now();
          let progressAnimationId = null;

          function updateImageProgress() {
            const elapsed = Date.now() - startTime;

            if (elapsed >= duration) {
              // Ensure progress bar reaches 100% before finishing
              updateAdProgress(duration, duration);
              if (progressAnimationId) {
                cancelAnimationFrame(progressAnimationId);
                progressAnimationId = null;
              }

              totalAdTime += duration; // Add the full 20 seconds
              console.log(`âœ… Image ${current + 1} complete. Total so far: ${Math.round(totalAdTime / 1000)}s`);
              nextAd();
            } else {
              updateAdProgress(duration, elapsed);
              progressAnimationId = requestAnimationFrame(updateImageProgress);
            }
          }

          // Start smooth progress animation
          progressAnimationId = requestAnimationFrame(updateImageProgress);

        } else if (ad.type === "video") {
          const src = "https://faculty-status-display.onrender.com" + ad.src;
          console.log(`ðŸŽ¥ Video ${current + 1}/${ads.length}: ${src}`);

          adVideo.pause();
          adVideo.removeAttribute("src");
          adVideo.load();

          let started = false;
          let finished = false;
          let videoDuration = null;
          let startTime = 0;
          let progressAnimationId = null;

          function cleanupVideo(actualDuration) {
            if (finished) return;
            finished = true;

            if (progressAnimationId) {
              cancelAnimationFrame(progressAnimationId);
              progressAnimationId = null;
            }

            // Clear all event listeners
            adVideo.onended = null;
            adVideo.onstalled = null;
            adVideo.onerror = null;
            adVideo.oncanplay = null;
            adVideo.onloadeddata = null;
            adVideo.onloadstart = null;
            adVideo.onabort = null;
            adVideo.style.display = "none";

            // Add the actual video duration to total
            totalAdTime += actualDuration;
            console.log(`âœ… Video ${current + 1} complete: ${Math.round(actualDuration / 1000)}s. Total so far: ${Math.round(totalAdTime / 1000)}s`);
            nextAd();
          }

          function startVideo() {
            if (started || finished) return;
            started = true;
            startTime = Date.now();

            adVideo.style.display = "block";
            setAdStretch(adVideo);

            // Get duration (prefer metadata, fallback to cap)
            if (isFinite(adVideo.duration) && adVideo.duration > 0) {
              videoDuration = Math.min(adVideo.duration * 1000, MAX_VIDEO_CAP_MS);
              console.log(`ðŸ“ Video duration: ${Math.round(videoDuration / 1000)}s (from metadata)`);
            } else {
              videoDuration = MAX_VIDEO_CAP_MS;
              console.log(`ðŸ“ No metadata, using elapsed time tracking (max ${MAX_VIDEO_CAP_MS / 1000}s)`);
            }

            adVideo.play().catch(err => {
              console.warn("âŒ Video play failed:", err);
              cleanupVideo(0);
              return;
            });

            updateAdProgress(videoDuration, 0);

            // Smooth progress animation
            function updateProgress() {
              if (finished) return;

              const elapsed = Date.now() - startTime;
              if (elapsed >= videoDuration) {
                console.log("â° Video reached duration limit");
                cleanupVideo(elapsed);
              } else {
                updateAdProgress(videoDuration, elapsed);
                progressAnimationId = requestAnimationFrame(updateProgress);
              }
            }

            progressAnimationId = requestAnimationFrame(updateProgress);
          }

          // Event handlers
          adVideo.onended = () => {
            if (!finished) {
              const elapsed = Date.now() - startTime;
              console.log("ðŸ”š Video ended naturally");
              cleanupVideo(elapsed);
            }
          };

          adVideo.oncanplay = () => {
            if (!started && !finished) startVideo();
          };

          adVideo.onloadeddata = () => {
            if (!started && !finished) startVideo();
          };

          adVideo.onerror = (e) => {
            console.error("âŒ Video error:", e);
            if (!finished) cleanupVideo(0);
          };

          adVideo.onstalled = () => {
            if (!started && !finished) {
              console.warn("âš ï¸ Video stalled before start, skipping");
              cleanupVideo(0);
            }
          };

          // Safety fallback
          setTimeout(() => {
            if (!started && !finished) {
              console.log("ðŸ”§ Force starting video (timeout fallback)");
              startVideo();
            }
          }, 3000);

          adVideo.src = src;
          adVideo.load();
        } else {
          console.warn("â“ Unknown ad type:", ad.type);
          nextAd();
        }
      }

      playNextAd();
    }

    function loadMarquee(forceUpdate = false) {
      fetch("https://faculty-status-display.onrender.com/api/marquee")
        .then(res => res.text())
        .then(text => {
          // Only update if text has changed or if forced
          if (text !== currentMarqueeText || forceUpdate) {
            const previousText = currentMarqueeText;
            currentMarqueeText = text;
            const marquee = document.getElementById("marqueeText");
            marquee.textContent = text;

            // Restart your existing animation for new text
            if (text !== previousText) {
              setTimeout(() => {
                animateMarquee(); // Uses your existing function
              }, 100);
            }

            if (forceUpdate) {
              console.log("ðŸ”„ Marquee manually refreshed:", text);
            } else if (text !== previousText) {
              console.log("ðŸ“ Marquee text updated automatically:", text);
            }
          }
        })
        .catch(err => {
          console.error("Failed to load marquee:", err);
        });
    }

    // Add this NEW function after loadMarquee (around line 620):
    function startSmartMarqueeCheck() {
      // Check every 15 seconds for changes (much faster than 5 minutes)
      marqueeCheckInterval = setInterval(() => {
        loadMarquee(false); // Check for updates without forcing
      }, 15000);
    }

    function animateMarquee() {
      const marquee = document.getElementById("marqueeText");

      if (marqueeAnimation) {
        cancelAnimationFrame(marqueeAnimation);
      }

      const container = marquee.parentElement;
      const containerWidth = container.offsetWidth - 160; // Account for smaller date-time display
      const textWidth = marquee.scrollWidth;

      // If text fits in container, no need to scroll
      if (textWidth <= containerWidth) {
        marquee.style.transform = 'translateX(0)';
        return;
      }

      const speed = 100; // pixels per second - adjust for desired speed
      const totalDistance = containerWidth + textWidth;
      const cycleDuration = totalDistance / speed * 1000; // ms for one complete cycle

      let animationStartTime = null;

      function animate(timestamp) {
        if (!animationStartTime) {
          animationStartTime = timestamp;
        }

        const elapsed = timestamp - animationStartTime;
        const cycleProgress = (elapsed % cycleDuration) / cycleDuration;

        // Calculate position (starts from right edge, moves to left)
        const position = containerWidth - (totalDistance * cycleProgress);

        // Use transform3d for better performance
        marquee.style.transform = `translate3d(${position}px, 0, 0)`;

        // Continue animation
        marqueeAnimation = requestAnimationFrame(animate);
      }

      // Start the animation
      marqueeAnimation = requestAnimationFrame(animate);
    }

    function updateDate() {
      if (!dateDisplay) {
        dateDisplay = document.getElementById("dateDisplay");
      }

      const now = new Date();
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

      const dayName = days[now.getDay()];
      const day = now.getDate();
      const month = months[now.getMonth()];
      const year = now.getFullYear();

      dateDisplay.textContent = `${dayName}, ${day} ${month} ${year}`;
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // Replace your existing updateBreakCountdown function with this smooth version:
    function updateBreakCountdown() {
      const now = Date.now();
      const countdownText = document.getElementById("adCountdownText");
      const progressBar = document.getElementById("adProgressBar");
      const adProgress = document.getElementById("adProgress");

      if (inBreakPeriod && breakEndsAt > now && breakStartTime > 0) {
        // Show break countdown with accurate progress
        const remainingMs = breakEndsAt - now;
        const remainingSeconds = Math.max(0, Math.ceil(remainingMs / 1000));

        // Calculate progress accurately
        const totalBreakMs = breakEndsAt - breakStartTime;
        const elapsedMs = now - breakStartTime;
        const progress = Math.min(100, Math.max(0, (elapsedMs / totalBreakMs) * 100));

        progressBar.style.width = progress + "%";
        countdownText.textContent = `Notice in: ${formatTime(remainingSeconds)}`;
        countdownText.classList.add("show");
        adProgress.className = "break-countdown";
        adProgress.style.display = "block";

      } else if (!adCycleRunning && !inBreakPeriod && ads.length > 0) {
        // Show "ready" state
        progressBar.style.width = "100%";
        countdownText.textContent = `Notice ready`;
        countdownText.classList.add("show");
        adProgress.className = "waiting-countdown";
        adProgress.style.display = "block";

      } else if (adCycleRunning) {
        // During ads - hide countdown text, show normal progress
        countdownText.classList.remove("show");
        adProgress.className = "";

      } else {
        // No ads available - hide everything
        countdownText.classList.remove("show");
        adProgress.style.display = "none";
      }
    }

    // Add this new smooth animation function:
    function smoothCountdownAnimation() {
      updateBreakCountdown();

      // Continue animation only if we're in break period or waiting
      if (inBreakPeriod || (!adCycleRunning && !inBreakPeriod && ads.length > 0)) {
        countdownAnimationId = requestAnimationFrame(smoothCountdownAnimation);
      } else {
        countdownAnimationId = null;
      }
    }

    // Add this function to start smooth countdown animation:
    function startSmoothCountdown() {
      if (!countdownAnimationId) {
        countdownAnimationId = requestAnimationFrame(smoothCountdownAnimation);
      }
    }

    // Add this function to stop smooth countdown animation:
    function stopSmoothCountdown() {
      if (countdownAnimationId) {
        cancelAnimationFrame(countdownAnimationId);
        countdownAnimationId = null;
      }
    }

    // Main initialization
    document.addEventListener("DOMContentLoaded", function () {
      updateClock();
      updateDate();
      loadFaculty();
      loadMarquee(true);
      loadAds();
      adjustLayout();

      setTimeout(() => {
        animateMarquee();
      }, 1000);

      setInterval(updateClock, 1000);
      setInterval(loadFaculty, 3000);
      startSmartMarqueeCheck();
      setInterval(loadAds, 300000);
      setInterval(updateDate, 60000);
      setInterval(checkAndStartAds, 10000);

      // START smooth countdown animation instead of interval
      startSmoothCountdown();
    });

    window.addEventListener("resize", adjustLayout);
  </script>
</body>

</html>